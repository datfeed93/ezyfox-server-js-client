var Guid=function(){};Guid.generate=function(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()};var EzyEventType=EzyEventType||{CONNECTION_SUCCESS:"CONNECTION_SUCCESS",CONNECTION_FAILURE:"CONNECTION_FAILURE",DISCONNECTION:"DISCONNECTION",MESSAGE:"MESSAGE"};Object.freeze(EzyEventType);var EzyCommand=EzyCommand||{ERROR:{id:10,name:"ERROR"},HANDSHAKE:{id:11,name:"HANDSHAKE"},PING:{id:12,name:"PING"},PONG:{id:13,name:"PONG"},DISCONNECT:{id:14,name:"DISCONNECT"},LOGIN:{id:20,name:"LOGIN"},LOGIN_ERROR:{id:21,name:"LOGIN_ERROR"},LOGOUT:{id:22,name:"LOGOUT"},APP_ACCESS:{id:30,name:"APP_ACCESS"},APP_REQUEST:{id:31,name:"APP_REQUEST"},APP_EXIT:{id:33,name:"APP_EXIT"},APP_ACCESS_ERROR:{id:34,name:"APP_ACCESS_ERROR"},PLUGIN_INFO:{id:40,name:"PLUGIN_INFO"},PLUGIN_REQUEST_BY_NAME:{id:41,name:"PLUGIN_REQUEST_BY_NAME"},PLUGIN_REQUEST_BY_ID:{id:42,name:"PLUGIN_REQUEST_BY_ID"}};Object.freeze(EzyCommand);var EzyCommands=EzyCommands||{};EzyCommands[EzyCommand.ERROR.id]=EzyCommand.ERROR;EzyCommands[EzyCommand.HANDSHAKE.id]=EzyCommand.HANDSHAKE;EzyCommands[EzyCommand.PING.id]=EzyCommand.PING;EzyCommands[EzyCommand.PONG.id]=EzyCommand.PONG;EzyCommands[EzyCommand.DISCONNECT.id]=EzyCommand.DISCONNECT;EzyCommands[EzyCommand.LOGIN.id]=EzyCommand.LOGIN;EzyCommands[EzyCommand.LOGIN_ERROR.id]=EzyCommand.LOGIN_ERROR;EzyCommands[EzyCommand.LOGOUT.id]=EzyCommand.LOGOUT;EzyCommands[EzyCommand.APP_ACCESS.id]=EzyCommand.APP_ACCESS;EzyCommands[EzyCommand.APP_REQUEST.id]=EzyCommand.APP_REQUEST;EzyCommands[EzyCommand.APP_EXIT.id]=EzyCommand.APP_EXIT;EzyCommands[EzyCommand.APP_ACCESS_ERROR.id]=EzyCommand.APP_ACCESS_ERROR;EzyCommands[EzyCommand.PLUGIN_INFO.id]=EzyCommand.PLUGIN_INFO;EzyCommands[EzyCommand.PLUGIN_REQUEST_BY_NAME.id]=EzyCommand.PLUGIN_REQUEST_BY_NAME;EzyCommands[EzyCommand.PLUGIN_REQUEST_BY_ID.id]=EzyCommand.PLUGIN_REQUEST_BY_ID;Object.freeze(EzyCommands);var EzyUnlogCommands=EzyUnlogCommands||{};EzyUnlogCommands=[EzyCommand.PING,EzyCommand.PONG];var EzyDisconnectReason=EzyDisconnectReason||{};EzyDisconnectReason.UNKNOWN=0;EzyDisconnectReason.IDLE=1;EzyDisconnectReason.NOT_LOGGED_IN=2;EzyDisconnectReason.ANOTHER_SESSION_LOGIN=3;EzyDisconnectReason.ADMIN_BAN=4;EzyDisconnectReason.ADMIN_KICK=5;EzyDisconnectReason.MAX_REQUEST_PER_SECOND=6;EzyDisconnectReason.MAX_REQUEST_SIZE=7;EzyDisconnectReason.SERVER_ERROR=8;EzyDisconnectReason.SERVER_NOT_RESPONSE=300;var EzyDisconnectReasonNames=EzyDisconnectReasonNames||{};EzyDisconnectReasonNames[EzyDisconnectReason.UNKNOWN]="UNKNOWN";EzyDisconnectReasonNames[EzyDisconnectReason.IDLE]="IDLE";EzyDisconnectReasonNames[EzyDisconnectReason.NOT_LOGGED_IN]="NOT_LOGGED_IN";EzyDisconnectReasonNames[EzyDisconnectReason.ANOTHER_SESSION_LOGIN]="ANOTHER_SESSION_LOGIN";EzyDisconnectReasonNames[EzyDisconnectReason.ADMIN_BAN]="ADMIN_BAN";EzyDisconnectReasonNames[EzyDisconnectReason.ADMIN_KICK]="ADMIN_KICK";EzyDisconnectReasonNames[EzyDisconnectReason.MAX_REQUEST_PER_SECOND]="MAX_REQUEST_PER_SECOND";EzyDisconnectReasonNames[EzyDisconnectReason.MAX_REQUEST_SIZE]="MAX_REQUEST_SIZE";EzyDisconnectReasonNames[EzyDisconnectReason.SERVER_ERROR]="SERVER_ERROR";EzyDisconnectReasonNames[EzyDisconnectReason.SERVER_NOT_RESPONSE]="SERVER_NOT_RESPONSE";var EzyZone=function(id,name){this.id=id;this.name=name;this.me=null;this.appList=[];this.appsById={};this.appsByName={};this.getApp=function(){return this.appList[0]};this.addApp=function(app){this.appList.push(app);this.appsById[app.id]=app;this.appsByName[app.name]=app}};var EzyApp=function(context,id,name){this.id=id;this.name=name;this.context=context;this.dataHandler=context.appDataHandlers[name];this.sendRequest=function(cmd,data){var requestData=[this.id,[cmd,data]];this.context.sendRequest(EzyCommand.APP_REQUEST,requestData)}};var EzyUser=function(id,name){this.id=id;this.name=name;this.joinedAppList=[];this.joinedAppsById={};this.joinedAppsByName={};this.addJoinedApp=function(app){this.joinedAppList.push(app);this.joinedAppsById[app.id]=app;this.joinedAppsByName[app.name]=app}};var EzyMessageEventHandler=function(){this.handle=function(context,message){var cmd=EzyCommands[message[0]];var data=message.length>1?message[1]:[];if(!EzyUnlogCommands.includes(cmd)){console.log("received cmd: "+cmd.name+", data: "+JSON.stringify(data))}if(cmd==EzyCommand.DISCONNECT){context.connected=false;context.disconnected=true;var disconnectReason=data[0];var eventHandler=context.getEventHandler(EzyEventType.DISCONNECTION);eventHandler.handle(context,disconnectReason)}else if(cmd==EzyCommand.PONG){var dataHandler=context.getDataHandler(EzyCommand.PONG);dataHandler.handle(context)}else{var handler=context.getDataHandler(cmd);if(handler)handler.handle(context,data);else console.log("has no handler with command: "+cmd.name)}}};var EzyConnectionEventHandler=function(){this.clientType="JAVASCRIPT";this.clientVersion="1.0.0";this.handle=function(context){this.sendHandshake(context)};this.sendHandshake=function(context){var clientId=this.getClientId();var clientKey=this.getClientKey();var token=this.getToken();var enableEncryption=this.isEnableEncryption();var request=[clientId,clientKey,this.clientType,this.clientVersion,enableEncryption,token];context.sendRequest(EzyCommand.HANDSHAKE,request)};this.getClientKey=function(){return""};this.getClientId=function(){return Guid.generate()};this.getToken=function(){return""};this.isEnableEncryption=function(){return false}};var EzyDisconnectionEventHandler=function(){this.handle=function(context,reason){var reasonName=EzyDisconnectReasonNames[reason];console.log("disconnected, reason: "+reasonName);context.stopPing()}};var EzyPongHandler=function(){this.handle=function(context){}};var EzyHandshakeHandler=function(){this.handle=function(context,data){this.sendLoginRequest(context);this.startPing(context)};this.startPing=function(context){context.startPing()};this.sendLoginRequest=function(context){var loginRequest=this.newLoginRequest(context);context.sendRequest(EzyCommand.LOGIN,loginRequest)};this.newLoginRequest=function(context){return["test","test","test",[]]}};var EzyLoginHandler=function(){this.handle=function(context,data){var zoneId=data[0];var zoneName=data[1];var userId=data[2];var username=data[3];var joinedAppArray=data[4];var responseData=data[5];var zone=new EzyZone(zoneId,zoneName);var user=new EzyUser(userId,username);zone.me=user;context.zone=zone;this.handleResponseAppDatas(context,joinedAppArray);this.handleResponseData(context,responseData);if(joinedAppArray.length<=0)this.handleLoginSuccess(context,responseData);else this.handleReconnectSuccess(context,responseData);console.log("user: "+user.name+" logged in successfully")};this.handleResponseData=function(context,data){};this.handleResponseAppDatas=function(context,appDatas){var appAccessHandler=context.getDataHandler(EzyCommand.APP_ACCESS);appDatas.forEach(function(app){appAccessHandler.handle(context,app)})};this.handleLoginSuccess=function(context,data){};this.handleReconnectSuccess=function(context,data){}};var EzyAppAccessHandler=function(){this.handle=function(context,data){var appId=data[0];var appName=data[1];var app=new EzyApp(context,appId,appName);var zone=context.zone;var me=zone.me;zone.addApp(app);me.addJoinedApp(app);this.handleAccessAppSuccess(context,app)};this.handleAccessApp=function(context,app){console.log("access app: "+app.name+" successfully");this.handleAccessAppSuccess(context,app)};this.handleAccessAppSuccess=function(context,app){}};var EzyAppResponseHandler=function(){this.handle=function(context,data){var appId=data[0];var responseData=data[1];var app=context.zone.appsById[appId];var handler=app.dataHandler;if(handler)handler.handle(app,responseData);else console.log("app: "+app.name+" has no handler")}};var EzyAppDataHandler=function(){this.handlers={};this.addHandler=function(cmd,handler){this.handlers[cmd]=handler};this.handle=function(app,data){var cmd=this.getCommand(data);var responseData=this.getResponseData(data);var handler=this.handlers[cmd];if(handler)handler(app,responseData);else console.log("app: "+app.name+" has no handler with command: "+cmd)};this.getCommand=function(data){return data[0]};this.getResponseData=function(data){return data[1]}};var EzyConnector=function(context){this.ws=null;this.connect=function(url){this.ws=new WebSocket(url);this.ws.onerror=function(e){console.log("error : "+e.message)};this.ws.onopen=function(){console.log("connected");context.connected=true;context.disconnected=false;var handler=context.eventHandlers[EzyEventType.CONNECTION_SUCCESS];handler.handle(context)};this.ws.onclose=function(){if(context.connected){var handler=context.eventHandlers[EzyEventType.DISCONNECTION];handler.handle(context,EzyDisconnectReason.UNKNOWN)}context.connected=false;context.disconnected=true};this.ws.onmessage=function(event){context.lostPingCount=0;var data=event.data;var message=JSON.parse(data);var handler=context.eventHandlers[EzyEventType.MESSAGE];handler.handle(context,message)}};this.disconnect=function(){this.ws.close()};this.send=function(data){var json=JSON.stringify(data);this.ws.send(json)}};var EzyClient=function(){this.connector=null;this.pingInterval=null;this.pingIntervalTime=3e3;this.connected=false;this.disconnected=false;this.lostPingCount=0;this.maxLostPingCount=3;this.zone=null;this.eventHandlers={};this.eventHandlers[EzyEventType.CONNECTION_SUCCESS]=new EzyConnectionEventHandler;this.eventHandlers[EzyEventType.MESSAGE]=new EzyMessageEventHandler;this.eventHandlers[EzyEventType.DISCONNECTION]=new EzyDisconnectionEventHandler;this.dataHandlers={};this.dataHandlers[EzyCommand.PONG.id]=new EzyPongHandler;this.dataHandlers[EzyCommand.HANDSHAKE.id]=new EzyHandshakeHandler;this.dataHandlers[EzyCommand.LOGIN.id]=new EzyLoginHandler;this.dataHandlers[EzyCommand.APP_ACCESS.id]=new EzyAppAccessHandler;this.dataHandlers[EzyCommand.APP_REQUEST.id]=new EzyAppResponseHandler;this.appDataHandlers={};this.connect=function(url){this.connector=new EzyConnector(this);this.connector.connect(url)};this.disconnect=function(){this.connector.disconnect()};this.send=function(data){this.connector.send(data)};this.sendRequest=function(cmd,data){if(!EzyUnlogCommands.includes(cmd)){console.log("send cmd: "+cmd.name+", data: "+JSON.stringify(data))}var request=[cmd.id,data];this.send(request)};this.addEventHandler=function(eventType,handler){this.eventHandlers[eventType]=handler};this.addDataHandler=function(cmd,handler){this.dataHandlers[cmd.id]=handler};this.addAppDataHandler=function(appName,handler){this.appDataHandlers[appName]=handler};this.getEventHandler=function(eventType){return this.eventHandlers[eventType]};this.getDataHandler=function(cmd){return this.dataHandlers[cmd.id]};this.getAppDataHandler=function(appName){return this.appDataHandlers[appName]};this.startPing=function(){var startPingNow=function(client){var pingInterval=setInterval(function(){if(client.lostPingCount<client.maxLostPingCount){client.lostPingCount++;client.sendRequest(EzyCommand.PING,[])}else{client.connected=false;client.disconnected=true;var handler=client.eventHandlers[EzyEventType.DISCONNECTION];handler.handle(client,EzyDisconnectReason.SERVER_NOT_RESPONSE);client.disconnect()}},client.pingIntervalTime);return pingInterval};this.stopPing();this.pingInterval=startPingNow(this)};this.stopPing=function(){if(this.pingInterval)clearInterval(this.pingInterval)}};var EzyClients=function(){var EzyClientsClass=function(){this.clients={};this.defaultClient="defaultClient";this.addClient=function(name,client){this.clients[name]=client};this.addDefaultClient=function(client){this.clients[this.defaultClient]=client};this.getClient=function(clientName){return this.clients[clientName]};this.getDefaultClient=function(){return this.clients[this.defaultClient]}};var instance=null;return{getInstance:function(){if(!instance){instance=new EzyClientsClass}return instance}}}();