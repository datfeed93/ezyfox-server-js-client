var Guid=function(){};Guid.generate=function(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()};var EzyRSAKeyPairGenerator=function(){this.generateKeyPair=function(keySize){var crypt=new JSEncrypt({default_key_size:keySize});var key=crypt.getKey();return key}};var EzyEventType=EzyEventType||{};EzyEventType.CONNECTION_SUCCESS="CONNECTION_SUCCESS";EzyEventType.CONNECTION_FAILURE="CONNECTION_FAILURE";EzyEventType.DISCONNECTION="DISCONNECTION";EzyEventType.MESSAGE="MESSAGE";var EzyCommand=EzyCommand||{};EzyCommand.ERROR=10;EzyCommand.HANDSHAKE=11;EzyCommand.PING=12;EzyCommand.PONG=13;EzyCommand.DISCONNECT=14;EzyCommand.LOGIN=20;EzyCommand.LOGIN_ERROR=21;EzyCommand.LOGOUT=22;EzyCommand.APP_ACCESS=30;EzyCommand.APP_REQUEST=31;EzyCommand.APP_EXIT=33;EzyCommand.APP_ACCESS_ERROR=34;EzyCommand.PLUGIN_INFO=40;EzyCommand.PLUGIN_REQUEST_BY_NAME=41;EzyCommand.PLUGIN_REQUEST_BY_ID=42;var EzyUnlogCommands=EzyUnlogCommands||{};EzyUnlogCommands=[EzyCommand.PING,EzyCommand.PONG];var EzyCommandNames=EzyCommandNames||{};EzyCommandNames[EzyCommand.ERROR]="ERROR";EzyCommandNames[EzyCommand.HANDSHAKE]="HANDSHAKE";EzyCommandNames[EzyCommand.PING]="PING";EzyCommandNames[EzyCommand.PONG]="PONG";EzyCommandNames[EzyCommand.DISCONNECT]="DISCONNECT";EzyCommandNames[EzyCommand.LOGIN]="LOGIN";EzyCommandNames[EzyCommand.LOGIN_ERROR]="LOGIN_ERROR";EzyCommandNames[EzyCommand.LOGOUT]="LOGOUT";EzyCommandNames[EzyCommand.APP_ACCESS]="APP_ACCESS";EzyCommandNames[EzyCommand.APP_REQUEST]="APP_REQUEST";EzyCommandNames[EzyCommand.APP_EXIT]="APP_EXIT";EzyCommandNames[EzyCommand.APP_ACCESS_ERROR]="APP_ACCESS_ERROR";EzyCommandNames[EzyCommand.PLUGIN_INFO]="PLUGIN_INFO";EzyCommandNames[EzyCommand.PLUGIN_REQUEST_BY_NAME]="PLUGIN_REQUEST_BY_NAME";EzyCommandNames[EzyCommand.PLUGIN_REQUEST_BY_ID]="PLUGIN_REQUEST_BY_ID";var EzyDisconnectReason=EzyDisconnectReason||{};EzyDisconnectReason.UNKNOWN=0;EzyDisconnectReason.IDLE=1;EzyDisconnectReason.NOT_LOGGED_IN=2;EzyDisconnectReason.ANOTHER_SESSION_LOGIN=3;EzyDisconnectReason.ADMIN_BAN=4;EzyDisconnectReason.ADMIN_KICK=5;EzyDisconnectReason.MAX_REQUEST_PER_SECOND=6;EzyDisconnectReason.MAX_REQUEST_SIZE=7;EzyDisconnectReason.SERVER_ERROR=8;EzyDisconnectReason.SERVER_NOT_RESPONSE=300;var EzyDisconnectReasonNames=EzyDisconnectReasonNames||{};EzyDisconnectReasonNames[EzyDisconnectReason.UNKNOWN]="UNKNOWN";EzyDisconnectReasonNames[EzyDisconnectReason.IDLE]="IDLE";EzyDisconnectReasonNames[EzyDisconnectReason.NOT_LOGGED_IN]="NOT_LOGGED_IN";EzyDisconnectReasonNames[EzyDisconnectReason.ANOTHER_SESSION_LOGIN]="ANOTHER_SESSION_LOGIN";EzyDisconnectReasonNames[EzyDisconnectReason.ADMIN_BAN]="ADMIN_BAN";EzyDisconnectReasonNames[EzyDisconnectReason.ADMIN_KICK]="ADMIN_KICK";EzyDisconnectReasonNames[EzyDisconnectReason.MAX_REQUEST_PER_SECOND]="MAX_REQUEST_PER_SECOND";EzyDisconnectReasonNames[EzyDisconnectReason.MAX_REQUEST_SIZE]="MAX_REQUEST_SIZE";EzyDisconnectReasonNames[EzyDisconnectReason.SERVER_ERROR]="SERVER_ERROR";EzyDisconnectReasonNames[EzyDisconnectReason.SERVER_NOT_RESPONSE]="SERVER_NOT_RESPONSE";var EzyZone=function(id,name){this.id=id;this.name=name;this.me=null;this.appList=[];this.appsById={};this.appsByName={};this.getApp=function(){return this.appList[0]};this.addApp=function(app){this.appList.push(app);this.appsById[app.id]=app;this.appsByName[app.name]=app}};var EzyApp=function(context,id,name){this.id=id;this.name=name;this.context=context;this.dataHandler=context.appDataHandlers[name];this.sendRequest=function(cmd,data){var requestData=[this.id,[cmd,data]];this.context.sendRequest(EzyCommand.APP_REQUEST,requestData)}};var EzyUser=function(id,name){this.id=id;this.name=name;this.joinedAppList=[];this.joinedAppsById={};this.joinedAppsByName={};this.addJoinedApp=function(app){this.joinedAppList.push(app);this.joinedAppsById[app.id]=app;this.joinedAppsByName[app.name]=app}};var EzyMessageEventHandler=function(){this.handle=function(context,message){var cmd=message[0];var data=message.length>1?message[1]:[];var cmdName=EzyCommandNames[cmd];if(!EzyUnlogCommands.includes(cmd)){console.log("received cmd: "+cmdName+", data: "+data)}if(cmd==EzyCommand.DISCONNECT){context.connected=false;context.disconnected=true;var disconnectReason=data[0];var eventHandler=context.eventHandlers[EzyEventType.DISCONNECTION];eventHandler.handle(context,disconnectReason)}else if(cmd==EzyCommand.PONG){var dataHandler=context.dataHandlers[EzyCommand.PONG];dataHandler.handle(context)}else{var handler=context.dataHandlers[cmd];if(handler)handler.handle(context,data);else console.log("has no handler with command: "+cmdName)}}};var EzyConnectionEventHandler=function(){this.clientType="JAVASCRIPT";this.clientVersion="1.0.0";this.handle=function(context){this.sendHandshake(context)};this.sendHandshake=function(context){var keyPair=this.loadKeyPair();var clientId=this.getClientId();var clientKey=keyPair.getPublicBaseKeyB64();var reconnectToken=this.getReconnectToken();var request=[clientId,clientKey,reconnectToken,this.clientType,this.clientVersion];context.sendRequest(EzyCommand.HANDSHAKE,request)};this.getReconnectToken=function(){return""};this.getClientId=function(){return Guid.generate()};this.loadKeyPair=function(){var keyPairGenerator=new EzyRSAKeyPairGenerator;var keyPair=keyPairGenerator.generateKeyPair(1024);return keyPair}};var EzyDisconnectionEventHandler=function(){this.handle=function(context,reason){var reasonName=EzyDisconnectReasonNames[reason];console.log("disconnected, reason: "+reasonName);context.stopPing()}};var EzyPongHandler=function(){this.handle=function(context){}};var EzyHandshakeHandler=function(){this.handle=function(context,data){this.sendLoginRequest(context);this.startPing(context)};this.startPing=function(context){context.startPing()};this.sendLoginRequest=function(context){var loginRequest=this.newLoginRequest(context);context.sendRequest(EzyCommand.LOGIN,loginRequest)};this.newLoginRequest=function(context){return["test","test","test",[]]}};var EzyLoginHandler=function(){this.handle=function(context,data){var zoneId=data[0];var zoneName=data[1];var userId=data[2];var username=data[3];var joinedAppArray=data[4];var responseData=data[5];var zone=new EzyZone(zoneId,zoneName);var user=new EzyUser(userId,username);joinedAppArray.forEach(function(item){var app=new EzyApp(context,item[0],item[1]);zone.addApp(app);user.addJoinedApp(app)});zone.me=user;context.zone=zone;this.handleResponseData(context,responseData);this.handleLoginSuccess(context);console.log("user: "+user.name+" logged in successfully");var appAccessHandler=context.dataHandlers[EzyCommand.APP_ACCESS];if(appAccessHandler){zone.appList.forEach(function(app){appAccessHandler.handleAccessApp(context,app)})}else{console.log("has no app access handler, ignore handling apps on user logged in")}};this.handleResponseData=function(context,data){};this.handleLoginSuccess=function(context){var me=context.zone.me;if(me.joinedAppList.length<=0)this.handleHasntJoinedApp(context);else this.handleHasJoinedApps(context)};this.handleHasntJoinedApp=function(context){};this.handleHasJoinedApps=function(context){var zone=context.zone;var appList=zone.appList;appList.forEach(function(app){})}};var EzyAppAccessHandler=function(){this.handle=function(context,data){var appId=data[0];var appName=data[1];var app=new EzyApp(context,appId,appName);var zone=context.zone;var me=zone.me;zone.addApp(app);me.addJoinedApp(app);this.handleAccessAppSuccess(context,app)};this.handleAccessApp=function(context,app){console.log("access app: "+app.name+" successfully");this.handleAccessAppSuccess(context,app)};this.handleAccessAppSuccess=function(context,app){}};var EzyAppResponseHandler=function(){this.handle=function(context,data){var appId=data[0];var responseData=data[1];var app=context.zone.appsById[appId];var handler=app.dataHandler;if(handler)handler.handle(app,responseData);else console.log("app: "+app.name+" has no handler")}};var EzyAppDataHandler=function(){this.handlers={};this.addHandler=function(cmd,handler){this.handlers[cmd]=handler};this.handle=function(app,data){var cmd=this.getCommand(data);var responseData=this.getResponseData(data);var handler=this.handlers[cmd];if(handler)handler(app,responseData);else console.log("app: "+app.name+" has no handler with command: "+cmd)};this.getCommand=function(data){return data[0]};this.getResponseData=function(data){return data[1]}};var EzyConnector=function(context){this.ws=null;this.connect=function(url){this.ws=new WebSocket(url);this.ws.onerror=function(e){console.log("error : "+e.message)};this.ws.onopen=function(){console.log("connected");context.connected=true;context.disconnected=false;var handler=context.eventHandlers[EzyEventType.CONNECTION_SUCCESS];handler.handle(context)};this.ws.onclose=function(){if(context.connected){var handler=context.eventHandlers[EzyEventType.DISCONNECTION];handler.handle(context,EzyDisconnectReason.UNKNOWN)}context.connected=false;context.disconnected=true};this.ws.onmessage=function(event){context.lostPingCount=0;var data=event.data;var message=JSON.parse(data);var handler=context.eventHandlers[EzyEventType.MESSAGE];handler.handle(context,message)}};this.disconnect=function(){this.ws.close()};this.send=function(data){var json=JSON.stringify(data);this.ws.send(json)}};var EzyClient=function(){this.connector=null;this.pingInterval=null;this.pingIntervalTime=3e3;this.connected=false;this.disconnected=false;this.lostPingCount=0;this.maxLostPingCount=3;this.zone=null;this.eventHandlers={};this.eventHandlers[EzyEventType.CONNECTION_SUCCESS]=new EzyConnectionEventHandler;this.eventHandlers[EzyEventType.MESSAGE]=new EzyMessageEventHandler;this.eventHandlers[EzyEventType.DISCONNECTION]=new EzyDisconnectionEventHandler;this.dataHandlers={};this.dataHandlers[EzyCommand.PONG]=new EzyPongHandler;this.dataHandlers[EzyCommand.HANDSHAKE]=new EzyHandshakeHandler;this.dataHandlers[EzyCommand.LOGIN]=new EzyLoginHandler;this.dataHandlers[EzyCommand.APP_ACCESS]=new EzyAppAccessHandler;this.appDataHandlers={};this.connect=function(url){this.connector=new EzyConnector(this);this.connector.connect(url)};this.disconnect=function(){this.connector.disconnect()};this.send=function(data){this.connector.send(data)};this.sendRequest=function(cmd,data){if(!EzyUnlogCommands.includes(cmd)){var cmdName=EzyCommandNames[cmd];console.log("send cmd: "+cmdName+", data: "+data)}var request=[cmd,data];this.send(request)};this.addEventHandler=function(eventType,handler){this.eventHandlers[eventType]=handler};this.addDataHandler=function(cmd,handler){this.dataHandlers[cmd]=handler};this.addAppDataHandler=function(appName,handler){this.appDataHandlers[appName]=handler};this.startPing=function(){var startPingNow=function(client){var pingInterval=setInterval(function(){if(client.lostPingCount<client.maxLostPingCount){client.lostPingCount++;client.sendRequest(EzyCommand.PING,[])}else{client.connected=false;client.disconnected=true;var handler=client.eventHandlers[EzyEventType.DISCONNECTION];handler.handle(client,EzyDisconnectReason.SERVER_NOT_RESPONSE);client.disconnect()}},client.pingIntervalTime);return pingInterval};this.stopPing();this.pingInterval=startPingNow(this)};this.stopPing=function(){if(this.pingInterval)clearInterval(this.pingInterval)}};